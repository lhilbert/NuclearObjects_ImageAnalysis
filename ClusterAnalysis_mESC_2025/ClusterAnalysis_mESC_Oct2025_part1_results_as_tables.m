load(fullfile(".", "AfterObjectAnalysis_combined_v7.mat"));

datasetInds = find(validFileFlag);
nDatasets = length(datasetInds);

% datasets results table
resTableDatasets = table( ...
    datasetInds', ...
    condInds', ...
    string(condNames'), ...
    numNuclei_vec', ...
    [cellfun(@(c) c(1), S5P_xyVoxelSizeCell)', cellfun(@(c) c(1), S5P_xyVoxelSizeCell)', cellfun(@(c) c(1), S5P_zVoxelSizeCell)'], ...
    VariableNames=["indDataset","condInd","condName","numNuclei","voxelSize"]);

% nuclei results table
resTableNuclei = table( ...
    zeros(0, 1), ...
    zeros(0, 1), ...
    zeros(0, 1), ...
    zeros(0, 3), ...
    zeros(0, 3), ...
    zeros(0, 3), ...
    zeros(0, 1), ...
    zeros(0, 1), ...
    zeros(0, 1), ...
    zeros(0, 1), ...
    VariableNames=["indDataset","indNucleus","volume","intensityMean","intensityStdDev","cytoIntensityMean","numClustersS5P","clusterVolumeMedianS5P","numClustersS2P","clusterVolumeMedianS2P"]);
for i = 1:nDatasets
    tempTable = table( ...
        repmat(datasetInds(i), resTableDatasets.numNuclei(i), 1), ...
        (1:resTableDatasets.numNuclei(i))', ...
        nuc_volCell{i}, ...
        cell2mat(nuc_intCell{i}), ...
        cell2mat(nuc_stdCell{i}), ...
        cell2mat(cyto_intCell{i}), ...
        perNuc_countCell{i}{1}, ...
        nuc_medianVolCell{i}{1}, ...
        perNuc_countCell{i}{2}, ...
        nuc_medianVolCell{i}{2}, ...
        VariableNames=["indDataset","indNucleus","volume","intensityMean","intensityStdDev","cytoIntensityMean","numClustersS5P","clusterVolumeMedianS5P","numClustersS2P","clusterVolumeMedianS2P"]);
    resTableNuclei = [resTableNuclei; tempTable];
end

% S5P cluster results table
resTableClustersS5P = table( ...
    zeros(0, 1), ...
    zeros(0, 1), ...
    zeros(0, 1), ...
    zeros(0, 1), ...
    zeros(0, 1), ...
    zeros(0, 3), ...
    zeros(0, 3), ...
    VariableNames=["indDataset","indNucleus","volume","solidity","elongation","centroid","intensity"]);
for i = 1:nDatasets
    nNuclei = numNuclei_vec(i);
    nucleusInds = cell(nNuclei, 1);
    for j = 1:nNuclei
        nucleusInds{j} = repmat(j, perNuc_countCell{i}{1}(j), 1);
    end
    nucleusInds = cell2mat(nucleusInds);
    tempTable = table( ...
        repmat(datasetInds(i), length(nucleusInds), 1), ...
        nucleusInds, ...
        S5P_volCell{i}, ...
        S5P_solCell{i}, ...
        S5P_eloCell{i}, ...
        S5P_centCell{i}, ...
        cell2mat(S5P_intCell{i}), ...
        VariableNames=["indDataset","indNucleus","volume","solidity","elongation","centroid","intensity"]);
    resTableClustersS5P = [resTableClustersS5P;tempTable];
end

% S2P cluster results table
resTableClustersS2P = table( ...
    zeros(0, 1), ...
    zeros(0, 1), ...
    zeros(0, 1), ...
    zeros(0, 1), ...
    zeros(0, 1), ...
    zeros(0, 3), ...
    zeros(0, 3), ...
    VariableNames=["indDataset","indNucleus","volume","solidity","elongation","centroid","intensity"]);
for i = 1:nDatasets
    nNuclei = numNuclei_vec(i);
    nucleusInds = cell(nNuclei, 1);
    for j = 1:nNuclei
        nucleusInds{j} = repmat(j, perNuc_countCell{i}{2}(j), 1);
    end
    nucleusInds = cell2mat(nucleusInds);
    tempTable = table( ...
        repmat(datasetInds(i), length(nucleusInds), 1), ...
        nucleusInds, ...
        S2P_volCell{i}, ...
        S2P_solCell{i}, ...
        S2P_eloCell{i}, ...
        S2P_centCell{i}, ...
        cell2mat(S2P_intCell{i}), ...
        VariableNames=["indDataset","indNucleus","volume","solidity","elongation","centroid","intensity"]);
    resTableClustersS2P = [resTableClustersS2P;tempTable];
end

% S5P cluster images
resClusterImagesS5P = cell(nDatasets, 1);
for i = 1:nDatasets
    resClusterImagesS5P{i} = cell(1, 2);
    resClusterImagesS5P{i}{1} = cell2mat(reshape(cellfun(@(c) c{1}, S5P_imgCell{i}, UniformOutput=false), 1, 1, []));
    resClusterImagesS5P{i}{2} = cell2mat(reshape(cellfun(@(c) c{2}, S5P_imgCell{i}, UniformOutput=false), 1, 1, []));
end

% S2P cluster images
resClusterImagesS2P = cell(nDatasets, 1);
for i = 1:nDatasets
    resClusterImagesS2P{i} = cell(1, 2);
    resClusterImagesS2P{i}{1} = cell2mat(reshape(cellfun(@(c) c{1}, S2P_imgCell{i}, UniformOutput=false), 1, 1, []));
    resClusterImagesS2P{i}{2} = cell2mat(reshape(cellfun(@(c) c{2}, S2P_imgCell{i}, UniformOutput=false), 1, 1, []));
end

% clear obsolete data
clear("batch*", "cond*", "cyto_intCell", "datasetInds", "i", "j", "nDatasets", ...
    "nNuclei", "nuc_intCell", "nuc_medianVolCell", "nuc_stdCell", "nuc_volCell", ...
    "nucleusInds", "numNuclei_vec", "perNuc*", "save_file", "S2P_centCell", ...
    "S2P_eloCell", "S2P_imgCell", "S2P_intCell", "S2P_nuc*", "S2P_solCell", ...
    "S2P_volCell", "S2P_xyVoxelSizeCell", "S2P_zVoxelSizeCell", "S5P_centCell", ...
    "S5P_eloCell", "S5P_imgCell", "S5P_intCell", "S5P_nuc*", "S5P_solCell", ...
    "S5P_volCell", "S5P_xyVoxelSizeCell", "S5P_zVoxelSizeCell", "tempTable");

% save results
save("AfterObjectAnalysis_combined_tab_v73.mat","-v7.3");
save("AfterObjectAnalysis_combined_tab_v7.mat");
